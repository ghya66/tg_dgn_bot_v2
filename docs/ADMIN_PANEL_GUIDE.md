# Bot 管理员面板使用指南

## 概述

Bot 管理员面板是集成在 Telegram Bot 内的配置管理工具，仅限 Bot Owner 访问。

### 核心特性

✅ **按钮式操作** - 无需手动编辑配置文件或输入命令  
✅ **实时生效** - 配置修改立即生效，无需重启 Bot  
✅ **安全可靠** - 仅 Bot Owner 可访问，所有操作记录审计日志  
✅ **数据持久化** - 使用 SQLite 数据库存储，重启后配置保留  
✅ **完整统计** - 查看订单、用户、收入等核心数据  

---

## 快速开始

### 1. 配置 Bot Owner

编辑 `.env` 文件，添加你的 Telegram 用户 ID：

```bash
BOT_OWNER_ID=123456789  # 替换为你的 Telegram 用户 ID
```

**如何获取你的用户 ID？**

1. 在 Telegram 中找到 `@userinfobot`
2. 给它发送任意消息或转发一条消息
3. 它会返回你的用户 ID（例如：`123456789`）

### 2. 初始化默认配置

首次使用前，运行初始化脚本：

```bash
python scripts/init_admin_config.py
```

这将创建数据库表并写入默认配置：

- **Premium 价格**：3个月=$10, 6个月=$18, 12个月=$30
- **TRX 汇率**：3.05
- **能量价格**：小能量=3 TRX, 大能量=6 TRX, 笔数套餐=3.6 TRX/笔
- **系统设置**：订单超时30分钟, 地址查询限频30分钟

### 3. 访问管理面板

在 Telegram 中给 Bot 发送命令：

```
/admin
```

如果你是 Bot Owner，将看到管理面板主菜单。如果不是，会提示"权限不足"。

---

## 功能详解

### 📊 统计数据

查看 Bot 运营核心指标：

**订单统计**
- 总订单数、待支付、已支付、已交付、已过期、已取消

**用户统计**
- 总用户数、今日新增、本周新增

**收入统计**
- 总收入、今日收入、本周收入、本月收入（仅统计已支付和已交付的订单）

**使用步骤**：
1. 点击 `📊 统计数据`
2. 查看完整统计报告
3. 点击 `🔙 返回` 回到主菜单

---

### 💰 价格配置

实时修改所有服务的价格：

#### Premium 会员价格

**当前默认值**：
- 3个月：$10 USDT
- 6个月：$18 USDT
- 12个月：$30 USDT

**修改步骤**：
1. 点击 `💰 价格配置`
2. 点击 `💎 Premium 会员`
3. 选择要修改的套餐（3/6/12个月）
4. 输入新价格（例如：`15.5`）
5. 确认修改，立即生效

#### TRX 兑换汇率

**当前默认值**：1 USDT = 3.05 TRX

**修改步骤**：
1. 点击 `💰 价格配置`
2. 点击 `🔄 TRX 汇率`
3. 点击 `✏️ 修改汇率`
4. 输入新汇率（例如：`3.15`）
5. 确认修改，立即生效

**注意**：汇率修改后，新订单使用新汇率，已创建订单不受影响。

#### 能量价格

**当前默认值**：
- 小能量（6.5万）：3 TRX
- 大能量（13.1万）：6 TRX
- 笔数套餐单价：3.6 TRX/笔

**修改步骤**：
1. 点击 `💰 价格配置`
2. 点击 `⚡ 能量价格`
3. 选择要修改的类型
4. 输入新价格（例如：`3.8`）
5. 确认修改，立即生效

---

### 📝 文案配置

修改 Bot 展示的文字内容：

#### 欢迎语

修改用户首次 `/start` 时看到的欢迎消息。

**修改步骤**：
1. 点击 `📝 文案配置`
2. 点击 `👋 欢迎语`
3. 查看当前文案
4. 发送新文案（支持HTML格式）
5. 确认修改，立即生效

**HTML格式示例**：
```html
👋 欢迎 <b>{first_name}</b>！

🎉 这里是 <b>USDT 代充服务</b>
💎 Premium 会员直充
⚡ 能量闪租
🔄 TRX 兑换

点击下方按钮开始使用！
```

#### 免费克隆文案

修改"免费克隆"功能的展示文案。

**修改步骤**：同上

#### 客服联系方式

修改客服 Telegram 账号（例如：`@your_support`）。

**修改步骤**：
1. 点击 `📝 文案配置`
2. 点击 `👨‍💼 客服联系`
3. 输入新客服账号（例如：`@new_support`）
4. 确认修改，立即生效

---

### 📦 订单管理

**当前状态**：即将上线，敬请期待！

**计划功能**：
- 查询订单列表（按状态筛选）
- 手动取消订单
- 手动退款
- 订单详情查询

---

### ⚙️ 系统设置

管理 Bot 的系统级配置：

#### 订单超时时间

**当前默认值**：30 分钟

修改后，新创建的订单将使用新超时时间。已创建订单不受影响。

**修改步骤**：
1. 点击 `⚙️ 系统设置`
2. 点击 `⏰ 订单超时`
3. 输入新时长（分钟，例如：`45`）
4. 确认修改，立即生效

#### 地址查询限频

**当前默认值**：30 分钟

修改后，用户查询地址后需等待新时长才能再次查询。

**修改步骤**：
1. 点击 `⚙️ 系统设置`
2. 点击 `🔍 查询限频`
3. 输入新时长（分钟，例如：`60`）
4. 确认修改，立即生效

#### 清理缓存

清理 Redis 中的所有缓存数据（包括后缀池、汇率缓存等）。

**使用场景**：
- 解决缓存同步问题
- 测试环境重置
- 后缀池状态异常

**修改步骤**：
1. 点击 `⚙️ 系统设置`
2. 点击 `🗑️ 清理缓存`
3. 确认操作（不可撤销）

⚠️ **警告**：清理缓存后，所有后缀将被释放，但不影响数据库中的订单记录。

#### 系统状态

查看 Bot 核心组件的运行状态：

- Redis 连接状态
- SQLite 数据库状态
- Bot 运行状态

**修改步骤**：
1. 点击 `⚙️ 系统设置`
2. 点击 `📊 系统状态`
3. 查看状态报告

---

## 审计日志

所有管理操作都会自动记录到审计日志，包括：

- **操作人**：管理员 Telegram 用户 ID
- **操作类型**：修改价格、修改文案、查看统计等
- **操作对象**：具体配置项（如 `premium_3_months`）
- **操作详情**：修改前后的值
- **操作结果**：成功/失败
- **操作时间**：精确到秒

**查看审计日志**（即将上线）：
- 通过管理面板查询最近操作记录
- 通过数据库直接查询 `audit_logs` 表

---

## 安全建议

### ✅ 推荐做法

1. **妥善保管 BOT_OWNER_ID** - 不要泄露给他人
2. **定期检查审计日志** - 发现异常操作及时处理
3. **测试环境验证** - 修改价格前先在测试环境验证
4. **备份数据库** - 定期备份 `data/bot.db`
5. **使用强密码** - Redis 和数据库（如果配置了远程访问）

### ❌ 避免做法

1. **不要分享截图** - 管理面板截图可能包含敏感信息
2. **不要在公开频道展示** - 避免暴露管理面板的存在
3. **不要频繁修改** - 价格频繁变动影响用户体验
4. **不要删除审计日志** - 重要的运维证据

---

## 常见问题

### Q1: 如何找回忘记的 BOT_OWNER_ID？

**答**：可以通过以下方式找回：
1. 给 `@userinfobot` 发送消息获取你的用户 ID
2. 检查 `.env` 文件中的 `BOT_OWNER_ID` 配置

### Q2: 修改价格后，旧订单会受影响吗？

**答**：不会。已创建的订单使用创建时的价格，不受后续价格修改影响。

### Q3: 可以添加多个管理员吗？

**答**：当前版本仅支持单个 Owner。如需多管理员，请联系开发者定制。

### Q4: 管理面板数据会丢失吗？

**答**：不会。所有配置存储在 SQLite 数据库中，除非删除 `data/bot.db` 文件，否则数据永久保留。

### Q5: 如何恢复默认配置？

**答**：重新运行初始化脚本：
```bash
python scripts/init_admin_config.py
```

**注意**：这会覆盖已修改的配置，请谨慎操作。

### Q6: 修改文案后格式乱了怎么办？

**答**：使用 HTML 标签确保格式正确：
- `<b>加粗</b>`
- `<i>斜体</i>`
- `<code>代码</code>`
- `<pre>预格式化</pre>`
- 换行使用 `\n`

### Q7: 无法访问管理面板，显示"权限不足"？

**答**：请检查：
1. `.env` 文件中 `BOT_OWNER_ID` 是否配置正确
2. 重启 Bot 使配置生效
3. 确认你的 Telegram 用户 ID 与配置一致

---

## 技术细节

### 数据库表结构

**price_configs** - 价格配置表
```sql
CREATE TABLE price_configs (
    id INTEGER PRIMARY KEY,
    config_key VARCHAR(100) UNIQUE,
    config_value FLOAT,
    description TEXT,
    updated_by INTEGER,
    updated_at TIMESTAMP
);
```

**content_configs** - 文案配置表
```sql
CREATE TABLE content_configs (
    id INTEGER PRIMARY KEY,
    config_key VARCHAR(100) UNIQUE,
    config_value TEXT,
    description TEXT,
    updated_by INTEGER,
    updated_at TIMESTAMP
);
```

**setting_configs** - 系统设置表
```sql
CREATE TABLE setting_configs (
    id INTEGER PRIMARY KEY,
    config_key VARCHAR(100) UNIQUE,
    config_value VARCHAR(255),
    description TEXT,
    updated_by INTEGER,
    updated_at TIMESTAMP
);
```

**audit_logs** - 审计日志表
```sql
CREATE TABLE audit_logs (
    id INTEGER PRIMARY KEY,
    admin_id INTEGER,
    action VARCHAR(50),
    target VARCHAR(100),
    details TEXT,
    result VARCHAR(20),
    ip_address VARCHAR(45),
    created_at TIMESTAMP
);
```

### 配置键名规范

**价格配置**：
- `premium_3_months` - Premium 3个月价格
- `premium_6_months` - Premium 6个月价格
- `premium_12_months` - Premium 12个月价格
- `trx_exchange_rate` - TRX 兑换汇率
- `energy_small` - 小能量价格
- `energy_large` - 大能量价格
- `energy_package_per_tx` - 笔数套餐单价

**文案配置**：
- `welcome_message` - 欢迎语
- `free_clone_message` - 免费克隆文案
- `support_contact` - 客服联系方式

**系统设置**：
- `order_timeout_minutes` - 订单超时时间（分钟）
- `address_query_rate_limit` - 地址查询限频（分钟）

---

## 更新日志

### v1.0.0 (2024-01-XX)

**首个版本发布**：

✅ 统计数据查询  
✅ 价格配置管理（Premium、TRX、能量）  
✅ 文案配置管理（欢迎语、克隆、客服）  
✅ 系统设置管理（超时、限频、缓存、状态）  
✅ 审计日志记录  
✅ 实时生效，无需重启  

⏳ 订单管理（即将上线）  
⏳ 多管理员支持（计划中）  
⏳ 审计日志查询（计划中）  

---

## 支持

如有问题或建议，请联系开发者或提交 GitHub Issue。

**文档最后更新**：2024-01-XX
