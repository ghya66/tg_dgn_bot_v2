# ğŸ” Telegram Bot å…¨é¢ä»£ç å®¡æŸ¥æŠ¥å‘Š

> ç”Ÿæˆæ—¶é—´: 2025-11-30
> å®¡æŸ¥èŒƒå›´: src/ ç›®å½•ä¸‹æ‰€æœ‰æ¨¡å—
> **æ›´æ–°: 2025-12-05 - ç¬¬äºŒè½®å®¡æŸ¥ä¿®å¤å®Œæˆ âœ…**

---

## ä¿®å¤è®°å½•

### ç¬¬ä¸€è½®ä¿®å¤ (2025-11-30)

| # | é—®é¢˜ | çŠ¶æ€ | ä¿®å¤æ–‡ä»¶ |
|---|------|------|---------|
| P0-1 | Premium æ–‡æ¡ˆä¸ä¸€è‡´ | âœ… å·²ä¿®å¤ | `menu/keyboards.py`, `menu/handler.py` |
| P0-2 | ä¸ªäººä¸­å¿ƒå›¾æ ‡ä¸ä¸€è‡´ | âœ… å·²ä¿®å¤ | `menu/keyboards.py`, `menu/handler.py` |
| P0-3 | TRX å›¾æ ‡ä¸ä¸€è‡´ | âœ… å·²ä¿®å¤ | `menu/keyboards.py`, `menu/handler.py`, `trx_exchange/handler.py` |
| P0-4 | Profile ç¼ºå°‘è¿”å›ä¸»èœå• | âœ… å·²ä¿®å¤ | `profile/keyboards.py` |
| P1-1 | Energy STATE_INPUT_COUNT æœªä½¿ç”¨ | â­ï¸ é™ä¸ºP2 | é—ç•™ä»£ç ï¼Œä¸å½±å“åŠŸèƒ½ |
| P1-2 | TRX Exchange è¾“å…¥é˜¶æ®µç¼ºå–æ¶ˆæŒ‰é’® | âœ… å·²ä¿®å¤ | `trx_exchange/keyboards.py`, `trx_exchange/handler.py` |
| P1-3 | è®¢å•è¿‡æœŸä¸é€šçŸ¥ç”¨æˆ· | âœ… å·²ä¿®å¤ | `tasks/order_expiry.py`, `bot_v2.py` |
| P2-1 | callback_data å‘½åä¸ç»Ÿä¸€ | âœ… å·²ä¿®å¤ | 6ä¸ª keyboards.py æ–‡ä»¶ç»Ÿä¸€ä¸º `nav_back_to_main` |
| P2-2 | éƒ¨åˆ†æ¨¡å—æœªä½¿ç”¨ error_collector | âœ… å·²ä¿®å¤ | `premium/handler.py`, `trx_exchange/payment_monitor.py` |
| P2-3 | Energy STATE_INPUT_COUNT é—ç•™ä»£ç  | âœ… å·²ä¿®å¤ | åˆ é™¤ `energy/states.py` å’Œ `handler.py` ä¸­çš„æ­»ä»£ç  |

### ç¬¬äºŒè½®ä¿®å¤ (2025-12-05)

| # | é—®é¢˜ | çŠ¶æ€ | ä¿®å¤æ–‡ä»¶ |
|---|------|------|---------|
| R2-1 | å¯¹è¯è¶…æ—¶æœªé…ç½® | âœ… å·²ä¿®å¤ | 6ä¸ªæ¨¡å—æ·»åŠ  `conversation_timeout=600` |
| R2-2 | Profile å……å€¼æµç¨‹ç¼ºå–æ¶ˆæŒ‰é’® | âœ… å·²ä¿®å¤ | `profile/handler.py` |
| R2-3 | è¿”å›ä¸»èœå•å›è°ƒä¸ç»Ÿä¸€ | âœ… å·²ä¿®å¤ | `address_query/handler.py` ç»Ÿä¸€ä¸º `nav_back_to_main` |
| R2-4 | æœªä½¿ç”¨çŠ¶æ€å¸¸é‡ | âœ… å·²ä¿®å¤ | `profile/states.py` åˆ é™¤ `SHOWING_PAYMENT` |
| R2-5 | çŠ¶æ€ç¼–å·ä¸ä¸€è‡´ | âœ… å·²ä¿®å¤ | `energy/states.py`, `address_query/states.py` ä»0å¼€å§‹ |
| R2-6 | TRX æ¶ˆæ¯ç¼º emoji | âœ… å·²ä¿®å¤ | `trx_exchange/messages.py` æ·»åŠ  ğŸ’± å‰ç¼€ |
| R2-7 | Help æ— ç”¨å±æ€§ | âœ… å·²ä¿®å¤ | `help/messages.py` åˆ é™¤ None å±æ€§ |
| R2-8 | æ³¨é‡Š typo | âœ… å·²ä¿®å¤ | `navigation_manager.py` ä¿®æ­£"æ¢å¤"ä¸º"æ¢å¤" |
| R2-9 | Admin å–æ¶ˆæ— æç¤º | âœ… å·²ä¿®å¤ | `bot_admin/handler.py` æ·»åŠ å–æ¶ˆæç¤ºæ¶ˆæ¯ |
| R2-10 | Premium ç”¨æˆ·åæ— é‡è¯•é™åˆ¶ | âœ… å·²ä¿®å¤ | `premium/handler.py` æ·»åŠ 3æ¬¡é‡è¯•é™åˆ¶ |

---

## ä¸€ã€æ¨¡å—æ³¨å†Œæ€»è§ˆ

### 1.1 æ¨¡å—æ³¨å†Œæƒ…å†µ

| æ¨¡å— | Priority | å…¥å£å‘½ä»¤ | å…¥å£æŒ‰é’® | callbackå‰ç¼€ | çŠ¶æ€ |
|------|---------|---------|---------|-------------|------|
| main_menu | 0 | `/start` | - | `back_to_main`, `menu_*` | âœ… |
| health | 1 | `/health` | - | - | âœ… |
| premium | 2 | `/premium` | `ğŸ’ Premiumä¼šå‘˜` | `premium_*` | âœ… |
| energy | 3 | `/energy` | `âš¡ èƒ½é‡å…‘æ¢` | `energy_*` | âœ… |
| address_query | 4 | `/query` | `ğŸ” åœ°å€æŸ¥è¯¢` | `addrq_*` | âœ… |
| profile | 5 | `/profile` | `ğŸ‘¤ ä¸ªäººä¸­å¿ƒ` | `profile_*` | âš ï¸ |
| trx_exchange | 6 | `/trx` | `ğŸ”„ TRX å…‘æ¢` | `trx_*` | âš ï¸ |
| admin | 10 | `/admin` | - | `admin_*` | âœ… |
| orders | 11 | `/orders` | - | `orders_*` | âœ… |
| help | 12 | `/help` | `â“ å¸®åŠ©` | `help_*` | âœ… |

### 1.2 Handler æ³¨å†Œæ£€æŸ¥ç»“æœ

- **é‡å¤æ³¨å†Œ**: âŒ æ— å‘ç°
- **ä¼˜å…ˆçº§å†²çª**: âŒ æ— å‘ç°
- **æ°¸è¿œä¸ç”Ÿæ•ˆçš„ handler**: âŒ æ— å‘ç°
- **å…¨å±€æ•è·å¹²æ‰°**: âš ï¸ `SafeConversationHandler` çš„ fallback ä¸­æœ‰ `filters.ALL` å¤„ç†å™¨ï¼Œä½†è®¾è®¡ä¸ºä¸å“åº”ï¼ˆè¿”å› Noneï¼‰

---

## äºŒã€å›¾æ ‡ & æ–‡æ¡ˆä¸€è‡´æ€§æ£€æŸ¥

### 2.1 å½“å‰ä½¿ç”¨æƒ…å†µå¯¹æ¯”è¡¨

| åŠŸèƒ½ | åº•éƒ¨é”®ç›˜ (ReplyKeyboard) | InlineKeyboard | messages.py | æ˜¯å¦ä¸€è‡´ |
|------|-------------------------|----------------|-------------|---------|
| Premium | `ğŸ’ Premiumä¼šå‘˜` | `ğŸ’ Premium å¼€é€š` / `ğŸ’ Premiumç›´å……` | `ğŸ Premium ä¼šå‘˜å¼€é€š` | âŒ ä¸ä¸€è‡´ |
| èƒ½é‡å…‘æ¢ | `âš¡ èƒ½é‡å…‘æ¢` | `âš¡ èƒ½é‡å…‘æ¢` | `âš¡ èƒ½é‡å…‘æ¢` | âœ… ä¸€è‡´ |
| åœ°å€æŸ¥è¯¢ | `ğŸ” åœ°å€æŸ¥è¯¢` | `ğŸ” åœ°å€æŸ¥è¯¢` | `ğŸ” åœ°å€æŸ¥è¯¢` | âœ… ä¸€è‡´ |
| ä¸ªäººä¸­å¿ƒ | `ğŸ‘¤ ä¸ªäººä¸­å¿ƒ` | `ğŸ  ä¸ªäººä¸­å¿ƒ` / `ğŸ’° æˆ‘çš„é’±åŒ…` | `ä¸ªäººä¸­å¿ƒ` | âŒ ä¸ä¸€è‡´ |
| TRXå…‘æ¢ | `ğŸ”„ TRX å…‘æ¢` | `ğŸ’± TRX å…‘æ¢` | `TRXé—ªå…‘` | âŒ ä¸ä¸€è‡´ |
| è”ç³»å®¢æœ | `ğŸ‘¨â€ğŸ’¼ è”ç³»å®¢æœ` | `ğŸ“ è”ç³»å®¢æœ` / `ğŸ‘¨â€ğŸ’¼ è”ç³»å®¢æœ` | - | âš ï¸ éƒ¨åˆ†ä¸ä¸€è‡´ |
| å¸®åŠ© | - | `â“ å¸®åŠ©` | - | âœ… ä¸€è‡´ |

### 2.2 éœ€è¦ä¿®æ”¹çš„æ–‡ä»¶æ¸…å•

| æ–‡ä»¶è·¯å¾„ | è¡Œå·èŒƒå›´ | å½“å‰æ–‡æ¡ˆ | å»ºè®®æ›¿æ¢ä¸º |
|---------|---------|---------|-----------|
| `src/modules/menu/handler.py` | 230-231 | `ğŸ’ Premiumç›´å……` | `ğŸ’ Premiumä¼šå‘˜` |
| `src/modules/menu/handler.py` | 231 | `ğŸ  ä¸ªäººä¸­å¿ƒ` | `ğŸ‘¤ ä¸ªäººä¸­å¿ƒ` |
| `src/modules/menu/handler.py` | 248 | `ğŸ”„ TRX å…‘æ¢` | `ğŸ’± TRXé—ªå…‘` |
| `src/modules/menu/keyboards.py` | 15 | `ğŸ’ Premium å¼€é€š` | `ğŸ’ Premiumä¼šå‘˜` |
| `src/modules/menu/keyboards.py` | 19 | `ğŸ’± TRX å…‘æ¢` | `ğŸ’± TRXé—ªå…‘` |
| `src/modules/menu/keyboards.py` | 23 | `ğŸ’° æˆ‘çš„é’±åŒ…` | `ğŸ‘¤ ä¸ªäººä¸­å¿ƒ` |
| `src/modules/premium/messages.py` | 11 | `ğŸ <b>Premium ä¼šå‘˜å¼€é€š</b>` | `ğŸ’ <b>Premiumä¼šå‘˜</b>` |

### 2.3 å»ºè®®ç»Ÿä¸€è§„èŒƒ

```
åŠŸèƒ½å›¾æ ‡ç»Ÿä¸€è§„èŒƒ:
ğŸ’ Premiumä¼šå‘˜    âš¡ èƒ½é‡å…‘æ¢      ğŸ” åœ°å€æŸ¥è¯¢
ğŸ‘¤ ä¸ªäººä¸­å¿ƒ       ğŸ’± TRXé—ªå…‘       ğŸ“‹ æˆ‘çš„è®¢å•
â“ å¸®åŠ©ä¸­å¿ƒ       ğŸ‘¨â€ğŸ’¼ è”ç³»å®¢æœ      ğŸ å…è´¹å…‹éš†
ğŸ’± å®æ—¶æ±‡ç‡       ğŸ”™ è¿”å›ä¸»èœå•     âŒ å–æ¶ˆ
âœ… ç¡®è®¤          ğŸ”„ é‡è¯•/åˆ·æ–°
```

---

## ä¸‰ã€callback_data å‰ç¼€æ˜ å°„è¡¨

### 3.1 æ‰€æœ‰ callback å‰ç¼€

| å‰ç¼€ | æ‰€å±æ¨¡å— | Handler ä½ç½® | ç”¨é€” |
|------|---------|-------------|------|
| `back_to_main` | menu | `handler.py:67` | è¿”å›ä¸»èœå• |
| `nav_back_to_main` | navigation | `navigation_manager.py` | è¿”å›ä¸»èœå•ï¼ˆç»Ÿä¸€å¯¼èˆªï¼‰ |
| `menu_back_to_main` | menu | `handler.py:67` | è¿”å›ä¸»èœå• |
| `addrq_back_to_main` | menu | `handler.py:67` | åœ°å€æŸ¥è¯¢è¿”å›ä¸»èœå• |
| `menu_premium` | menu | ç”± premium å…¥å£å¤„ç† | è¿›å…¥ Premium |
| `menu_energy` | menu | ç”± energy å…¥å£å¤„ç† | è¿›å…¥èƒ½é‡å…‘æ¢ |
| `menu_profile` | menu | ç”± profile å…¥å£å¤„ç† | è¿›å…¥ä¸ªäººä¸­å¿ƒ |
| `menu_address_query` | menu | ç”± address_query å…¥å£å¤„ç† | è¿›å…¥åœ°å€æŸ¥è¯¢ |
| `menu_trx_exchange` | menu | ç”± trx_exchange å…¥å£å¤„ç† | è¿›å…¥ TRX å…‘æ¢ |
| `menu_help` | menu | ç”± help å…¥å£å¤„ç† | è¿›å…¥å¸®åŠ© |
| `menu_support` | menu | `handler.py:257` | è”ç³»å®¢æœ |
| `menu_clone` | menu | `handler.py:172` | å…è´¹å…‹éš† |
| `menu_orders` | menu | `handler.py:285` | æˆ‘çš„è®¢å• |
| `premium_self` | premium | `handler.py:101` | ç»™è‡ªå·±å¼€é€š |
| `premium_other` | premium | `handler.py:102` | ç»™ä»–äººå¼€é€š |
| `premium_\d+` | premium | `handler.py:105` | é€‰æ‹©å¥—é¤ |
| `premium_confirm_*` | premium | `handler.py:111-119` | ç¡®è®¤æ“ä½œ |
| `premium_retry_*` | premium | `handler.py:111-116` | é‡è¯•æ“ä½œ |
| `premium_cancel_order` | premium | `handler.py:119` | å–æ¶ˆè®¢å• |
| `energy_type_*` | energy | `handler.py:70` | é€‰æ‹©èƒ½é‡ç±»å‹ |
| `energy_pkg_*` | energy | `handler.py:73` | é€‰æ‹©å¥—é¤ |
| `energy_back` | energy | `handler.py:74` | è¿”å›ä¸Šä¸€çº§ |
| `energy_cancel` | energy | `handler.py:94` | å–æ¶ˆ |
| `energy_payment_done` | energy | `handler.py:86` | ç¡®è®¤å·²æ”¯ä»˜ |
| `energy_skip_hash` | energy | `handler.py:90` | è·³è¿‡å“ˆå¸Œ |
| `addrq_cancel` | address_query | `handler.py:73` | å–æ¶ˆ |
| `profile_balance` | profile | `handler.py:64` | æŸ¥çœ‹ä½™é¢ |
| `profile_deposit` | profile | `handler.py:65` | å……å€¼ |
| `profile_history` | profile | `handler.py:66` | å……å€¼è®°å½• |
| `profile_back` | profile | `handler.py:67` | è¿”å›ä¸ªäººä¸­å¿ƒ |
| `trx_paid_*` | trx_exchange | `handler.py:77` | ç¡®è®¤æ”¯ä»˜ |
| `trx_cancel_*` | trx_exchange | `handler.py:77` | å–æ¶ˆ |
| `trx_skip_hash` | trx_exchange | `handler.py:81` | è·³è¿‡å“ˆå¸Œ |
| `orders_*` | orders | `query_handler.py` | è®¢å•ç®¡ç†æ“ä½œ |
| `help_*` | help | `handler.py:53-55` | å¸®åŠ©åˆ†ç±» |

### 3.2 å­¤å„¿å›è°ƒæ£€æŸ¥

| callback_data | çŠ¶æ€ | è¯´æ˜ |
|---------------|------|------|
| `menu_admin` | âš ï¸ | åœ¨é»˜è®¤æŒ‰é’®é…ç½®ä¸­å¯èƒ½å­˜åœ¨ï¼Œä½†åŠ¨æ€é…ç½®å¯èƒ½è¦†ç›– |
| `profile_back` | âš ï¸ | åªè¿”å› profile ä¸»ç•Œé¢ï¼Œç”¨æˆ·æ— æ³•ç›´æ¥è¿”å›ä¸»èœå• |

---

## å››ã€çŠ¶æ€æœºï¼ˆFSMï¼‰åˆ†æ

### 4.1 Premium æ¨¡å—

```
çŠ¶æ€æµè½¬å›¾:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  START â”€â”€â†’ SELECTING_TARGET                                  â”‚
â”‚                  â”‚                                           â”‚
â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                               â”‚
â”‚      â†“           â†“           â†“                               â”‚
â”‚  premium_self  premium_other  nav_back_to_main â†’ END         â”‚
â”‚      â”‚           â”‚                                           â”‚
â”‚      â”‚           â†“                                           â”‚
â”‚      â”‚    ENTERING_USERNAME                                  â”‚
â”‚      â”‚           â”‚                                           â”‚
â”‚      â”‚           â†“                                           â”‚
â”‚      â”‚    AWAITING_USERNAME_ACTION â”€â”€â†’ retry â†’ ENTERING_USERNAME â”‚
â”‚      â”‚           â”‚                                           â”‚
â”‚      â”‚           â†“                                           â”‚
â”‚      â”‚    VERIFYING_USERNAME                                 â”‚
â”‚      â”‚           â”‚                                           â”‚
â”‚      â†“           â†“                                           â”‚
â”‚  SELECTING_PACKAGE                                           â”‚
â”‚      â”‚                                                       â”‚
â”‚      â†“                                                       â”‚
â”‚  CONFIRMING_ORDER                                            â”‚
â”‚      â”‚                                                       â”‚
â”‚      â”œâ”€â”€â†’ confirm_payment â†’ END                              â”‚
â”‚      â””â”€â”€â†’ cancel_order â†’ END                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

âœ… çŠ¶æ€æœºå®Œæ•´ï¼Œæ¯ä¸ªçŠ¶æ€éƒ½æœ‰é€€å‡ºè·¯å¾„
```

### 4.2 Energy æ¨¡å—

```
çŠ¶æ€æµè½¬å›¾:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  START â”€â”€â†’ STATE_SELECT_TYPE                                 â”‚
â”‚                  â”‚                                           â”‚
â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚      â†“           â†“           â†“              â†“                â”‚
â”‚   hourly      package      flash      back_to_main â†’ END     â”‚
â”‚      â”‚           â”‚           â”‚                               â”‚
â”‚      â†“           â†“           â†“                               â”‚
â”‚  STATE_SELECT_PACKAGE  STATE_INPUT_USDT                      â”‚
â”‚      â”‚                       â”‚                               â”‚
â”‚      â†“                       â†“                               â”‚
â”‚  STATE_INPUT_ADDRESS â†â”€â”€â”€â”€â”€â”€â”€â”˜                               â”‚
â”‚      â”‚                                                       â”‚
â”‚      â†“                                                       â”‚
â”‚  STATE_SHOW_PAYMENT                                          â”‚
â”‚      â”‚                                                       â”‚
â”‚      â†“                                                       â”‚
â”‚  STATE_INPUT_TX_HASH                                         â”‚
â”‚      â”‚                                                       â”‚
â”‚      â”œâ”€â”€â†’ è¾“å…¥å“ˆå¸Œ â†’ END                                      â”‚
â”‚      â””â”€â”€â†’ skip â†’ END                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

âš ï¸ é—®é¢˜: STATE_INPUT_COUNT å®šä¹‰äº†ä½†æœªåœ¨ states ä¸­ä½¿ç”¨
```

### 4.3 Profile æ¨¡å—

```
çŠ¶æ€æµè½¬å›¾:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  START â”€â”€â†’ MAIN_MENU                                         â”‚
â”‚                  â”‚                                           â”‚
â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚      â†“           â†“           â†“              â†“                â”‚
â”‚   balance     deposit     history      profile_back          â”‚
â”‚      â”‚           â”‚           â”‚              â”‚                â”‚
â”‚      â†“           â†“           â†“              â†“                â”‚
â”‚  â†’ MAIN_MENU  AWAITING_DEPOSIT_AMOUNT  â†’ MAIN_MENU  â†’ MAIN_MENU â”‚
â”‚                  â”‚                                           â”‚
â”‚                  â†“                                           â”‚
â”‚              è¾“å…¥é‡‘é¢ â†’ END                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

âš ï¸ é—®é¢˜: æ²¡æœ‰ç›´æ¥è¿”å›ä¸»èœå•çš„è·¯å¾„ï¼Œç”¨æˆ·è¢«å›°åœ¨ profile ç•Œé¢
```

### 4.4 TRX Exchange æ¨¡å—

```
çŠ¶æ€æµè½¬å›¾:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  START â”€â”€â†’ INPUT_AMOUNT                                      â”‚
â”‚                  â”‚                                           â”‚
â”‚                  â†“                                           â”‚
â”‚            è¾“å…¥ USDT é‡‘é¢                                     â”‚
â”‚                  â”‚                                           â”‚
â”‚                  â†“                                           â”‚
â”‚            INPUT_ADDRESS                                     â”‚
â”‚                  â”‚                                           â”‚
â”‚                  â†“                                           â”‚
â”‚            è¾“å…¥ TRX åœ°å€                                      â”‚
â”‚                  â”‚                                           â”‚
â”‚                  â†“                                           â”‚
â”‚            CONFIRM_PAYMENT                                   â”‚
â”‚                  â”‚                                           â”‚
â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                               â”‚
â”‚      â†“                       â†“                               â”‚
â”‚   trx_paid_*            trx_cancel_* â†’ END                   â”‚
â”‚      â”‚                                                       â”‚
â”‚      â†“                                                       â”‚
â”‚   INPUT_TX_HASH                                              â”‚
â”‚      â”‚                                                       â”‚
â”‚      â”œâ”€â”€â†’ è¾“å…¥å“ˆå¸Œ â†’ END                                      â”‚
â”‚      â””â”€â”€â†’ skip â†’ END                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

âš ï¸ é—®é¢˜: INPUT_AMOUNT å’Œ INPUT_ADDRESS çŠ¶æ€ç¼ºå°‘å–æ¶ˆæŒ‰é’®
```

---

## äº”ã€é—®é¢˜æ¸…å•ï¼ˆæŒ‰ä¼˜å…ˆçº§æ’åºï¼‰

### ğŸ”´ P0 - é«˜ä¼˜å…ˆçº§

#### 5.1 [P0-1] Profile æ¨¡å—ç¼ºå°‘è¿”å›ä¸»èœå•æŒ‰é’®

- **æ–‡ä»¶**: `src/modules/profile/keyboards.py`
- **è¡Œå·**: 20-25
- **æè¿°**: `back_to_profile()` é”®ç›˜åªæœ‰"è¿”å›ä¸ªäººä¸­å¿ƒ"ï¼Œç¼ºå°‘"è¿”å›ä¸»èœå•"
- **å½±å“**: ç”¨æˆ·è¿›å…¥ profile å­é¡µé¢åæ— æ³•å¿«é€Ÿè¿”å›ä¸»èœå•
- **å»ºè®®ä¿®å¤**:
```python
@staticmethod
def back_to_profile():
    return InlineKeyboardMarkup([
        [InlineKeyboardButton("ğŸ”™ è¿”å›ä¸ªäººä¸­å¿ƒ", callback_data="profile_back")],
        [InlineKeyboardButton("ğŸ  è¿”å›ä¸»èœå•", callback_data="back_to_main")],  # æ–°å¢
    ])
```
- **æµ‹è¯•ç”¨ä¾‹**: è¿›å…¥ä¸ªäººä¸­å¿ƒâ†’ä½™é¢æŸ¥è¯¢â†’éªŒè¯èƒ½çœ‹åˆ°è¿”å›ä¸»èœå•æŒ‰é’®

#### 5.2 [P0-2] å›¾æ ‡æ–‡æ¡ˆä¸ä¸€è‡´

- **æ–‡ä»¶**: å¤šå¤„ï¼ˆè§ 2.2 æ¸…å•ï¼‰
- **æè¿°**: åŒä¸€åŠŸèƒ½åœ¨åº•éƒ¨é”®ç›˜ã€InlineKeyboardã€æ¶ˆæ¯æ ‡é¢˜ä¸­ä½¿ç”¨ä¸åŒå›¾æ ‡/æ–‡æ¡ˆ
- **å½±å“**: ç”¨æˆ·ä½“éªŒå‰²è£‚ï¼Œå“ç‰Œä¸€è‡´æ€§å·®
- **å»ºè®®ä¿®å¤**: æŒ‰ç…§ 2.2 æ¸…å•ç»Ÿä¸€ä¿®æ”¹
- **æµ‹è¯•ç”¨ä¾‹**: æ£€æŸ¥æ‰€æœ‰å…¥å£æŒ‰é’®å’Œæ ‡é¢˜æ˜¯å¦ä½¿ç”¨ç›¸åŒå›¾æ ‡

### ğŸŸ¡ P1 - ä¸­ä¼˜å…ˆçº§

#### 5.3 [P1-1] Energy æ¨¡å— STATE_INPUT_COUNT æœªä½¿ç”¨

- **æ–‡ä»¶**: `src/modules/energy/handler.py`
- **è¡Œå·**: 79-80, 283-306
- **æè¿°**: å®šä¹‰äº† `input_count` æ–¹æ³•ä½† states å­—å…¸ä¸­æ²¡æœ‰å¯¹åº”çŠ¶æ€è½¬ç§»
- **å½±å“**: ç¬”æ•°å¥—é¤çš„æµç¨‹å¯èƒ½ä¸å®Œæ•´
- **å»ºè®®ä¿®å¤**: ç¡®è®¤æ˜¯å¦éœ€è¦è¯¥çŠ¶æ€ï¼Œå¦‚éœ€è¦åˆ™è¡¥å…¨çŠ¶æ€æœº

#### 5.4 [P1-2] TRX Exchange è¾“å…¥é˜¶æ®µç¼ºå°‘å–æ¶ˆæŒ‰é’®

- **æ–‡ä»¶**: `src/modules/trx_exchange/handler.py`
- **è¡Œå·**: 100-157
- **æè¿°**: `INPUT_AMOUNT` å’Œ `INPUT_ADDRESS` çŠ¶æ€åªæç¤ºç”¨æˆ·è¾“å…¥ï¼Œæ²¡æœ‰å–æ¶ˆé€‰é¡¹
- **å½±å“**: ç”¨æˆ·è¯¯å…¥æµç¨‹ååªèƒ½è¾“å…¥æˆ–ç­‰å¾…è¶…æ—¶
- **å»ºè®®ä¿®å¤**: åœ¨è¿™ä¸¤ä¸ªçŠ¶æ€å‘é€æ¶ˆæ¯æ—¶æ·»åŠ å–æ¶ˆæŒ‰é’®

#### 5.5 [P1-3] è®¢å•è¿‡æœŸä¸é€šçŸ¥ç”¨æˆ·

- **æ–‡ä»¶**: `src/tasks/order_expiry.py`
- **è¡Œå·**: 102-123
- **æè¿°**: `_expire_single_order` åªæ›´æ–°æ•°æ®åº“çŠ¶æ€ï¼Œä¸å‘é€æ¶ˆæ¯é€šçŸ¥ç”¨æˆ·
- **å½±å“**: ç”¨æˆ·ä¸çŸ¥é“è®¢å•å·²è¿‡æœŸï¼Œå¯èƒ½ç»§ç»­ç­‰å¾…
- **å»ºè®®ä¿®å¤**: æ·»åŠ  bot.send_message é€šçŸ¥é€»è¾‘ï¼ˆéœ€è¦ä¼ å…¥ bot å®ä¾‹ï¼‰

### ğŸŸ¢ P2 - ä½ä¼˜å…ˆçº§

#### 5.6 [P2-1] callback_data å‘½åä¸å®Œå…¨ç»Ÿä¸€

- **æè¿°**: è¿”å›ä¸»èœå•æœ‰ 4 ç§ä¸åŒçš„ callback_data
- **å½±å“**: ä»£ç ç»´æŠ¤å¤æ‚åº¦ç•¥é«˜
- **å»ºè®®**: é•¿æœŸå¯ç»Ÿä¸€ä¸º `nav_back_to_main`

#### 5.7 [P2-2] éƒ¨åˆ†æ¨¡å—æœªä½¿ç”¨ error_collector

- **æ–‡ä»¶**: å¤šå¤„ï¼ˆè§ grep ç»“æœï¼‰
- **æè¿°**: éƒ¨åˆ† `except Exception` åªç”¨ `logger.error`ï¼Œæœªè°ƒç”¨ `error_collector.collect`
- **å½±å“**: é”™è¯¯ç»Ÿè®¡ä¸å®Œæ•´
- **å»ºè®®**: å…³é”®ä¸šåŠ¡æµç¨‹é”™è¯¯åº”åŒæ—¶è®°å½•åˆ° error_collector

---

## å…­ã€åŠŸèƒ½æ€§æµ‹è¯•ç”¨ä¾‹è®¾è®¡

### 6.1 ä¸»èœå•å¯¼èˆªå†’çƒŸæµ‹è¯•è¡¨

| # | å…¥å£ | æ“ä½œ | é¢„æœŸç»“æœ | è¿›å…¥çŠ¶æ€ |
|---|------|------|---------|---------|
| 1 | `/start` | - | æ˜¾ç¤ºæ¬¢è¿è¯­ + InlineKeyboard + ReplyKeyboard | - |
| 2 | `ğŸ’ Premiumä¼šå‘˜` | ç‚¹å‡»åº•éƒ¨é”®ç›˜ | æ˜¾ç¤º Premium é€‰æ‹©ç•Œé¢ | SELECTING_TARGET |
| 3 | `âš¡ èƒ½é‡å…‘æ¢` | ç‚¹å‡»åº•éƒ¨é”®ç›˜ | æ˜¾ç¤ºèƒ½é‡ç±»å‹é€‰æ‹© | STATE_SELECT_TYPE |
| 4 | `ğŸ” åœ°å€æŸ¥è¯¢` | ç‚¹å‡»åº•éƒ¨é”®ç›˜ | æç¤ºè¾“å…¥åœ°å€ | AWAITING_ADDRESS |
| 5 | `ğŸ‘¤ ä¸ªäººä¸­å¿ƒ` | ç‚¹å‡»åº•éƒ¨é”®ç›˜ | æ˜¾ç¤ºä½™é¢å’Œæ“ä½œæŒ‰é’® | MAIN_MENU |
| 6 | `ğŸ”„ TRX å…‘æ¢` | ç‚¹å‡»åº•éƒ¨é”®ç›˜ | æç¤ºè¾“å…¥é‡‘é¢ | INPUT_AMOUNT |
| 7 | `ğŸ’± å®æ—¶æ±‡ç‡` | ç‚¹å‡»åº•éƒ¨é”®ç›˜ | æ˜¾ç¤º OKX C2C æ±‡ç‡ | - |
| 8 | `ğŸ å…è´¹å…‹éš†` | ç‚¹å‡»åº•éƒ¨é”®ç›˜ | æ˜¾ç¤ºå…‹éš†è¯´æ˜ | - |
| 9 | `ğŸ‘¨â€ğŸ’¼ è”ç³»å®¢æœ` | ç‚¹å‡»åº•éƒ¨é”®ç›˜ | æ˜¾ç¤ºå®¢æœè”ç³»æ–¹å¼ | - |
| 10 | `ğŸ”™ è¿”å›ä¸»èœå•` | ä»»æ„æ¨¡å—å†…ç‚¹å‡» | è¿”å›ä¸»èœå•ï¼Œæ¸…ç†çŠ¶æ€ | - |

### 6.2 Premium è´­ä¹°æµç¨‹æµ‹è¯•

```
æµ‹è¯•åœºæ™¯: ç»™è‡ªå·±è´­ä¹° 3 ä¸ªæœˆ Premium

æ­¥éª¤:
1. å‘é€ /start
2. ç‚¹å‡» "ğŸ’ Premiumä¼šå‘˜" åº•éƒ¨é”®ç›˜æŒ‰é’®
3. ç‚¹å‡» "ğŸ’ ç»™è‡ªå·±å¼€é€š"
4. ç‚¹å‡» "3ä¸ªæœˆ - $17.0"
5. éªŒè¯: 
   - è®¢å•å·²åˆ›å»ºï¼ˆæ•°æ®åº“æœ‰è®°å½•ï¼‰
   - é‡‘é¢åç¼€å·²åˆ†é…ï¼ˆsuffix_managerï¼‰
   - æ˜¾ç¤ºæ­£ç¡®çš„æ”¯ä»˜ä¿¡æ¯
6. ç‚¹å‡» "âœ… ç¡®è®¤æ”¯ä»˜"
7. éªŒè¯: æ˜¾ç¤ºæ”¯ä»˜æˆåŠŸæç¤º
8. ç‚¹å‡» "âŒ å–æ¶ˆè®¢å•"ï¼ˆå¦ä¸€æ¡æµ‹è¯•è·¯å¾„ï¼‰
9. éªŒè¯: è®¢å•çŠ¶æ€æ›´æ–°ä¸º CANCELLED

é¢„æœŸçŠ¶æ€æµè½¬:
SELECTING_TARGET â†’ SELECTING_PACKAGE â†’ CONFIRMING_ORDER â†’ END
```

### 6.3 åœ°å€æŸ¥è¯¢æµç¨‹æµ‹è¯•

```
æµ‹è¯•åœºæ™¯: æŸ¥è¯¢æœ‰æ•ˆ TRON åœ°å€

æ­¥éª¤:
1. å‘é€ /start
2. ç‚¹å‡» "ğŸ” åœ°å€æŸ¥è¯¢"
3. è¾“å…¥æœ‰æ•ˆåœ°å€: TN4Q8tMXKX3Y2ZYQVEjuUVHjvNGVhvJKrG
4. éªŒè¯:
   - æ˜¾ç¤º "æŸ¥è¯¢ä¸­..." æç¤º
   - æ˜¾ç¤ºä½™é¢ä¿¡æ¯
   - æ˜¾ç¤ºé“¾ä¸ŠæŸ¥è¯¢é“¾æ¥
5. ç‚¹å‡» "ğŸ”™ è¿”å›ä¸»èœå•"

é”™è¯¯åœºæ™¯æµ‹è¯•:
- è¾“å…¥æ— æ•ˆåœ°å€ï¼ˆçŸ­äº34ä½ï¼‰
- è¾“å…¥ä»¥å¤ªåŠåœ°å€ï¼ˆ0xå¼€å¤´ï¼‰
- è¿ç»­å¿«é€ŸæŸ¥è¯¢ï¼ˆé™é¢‘æµ‹è¯•ï¼‰
```

---

## ä¸ƒã€é‡æ„é¡ºåºå»ºè®®

```
Phase 1: å›¾æ ‡æ–‡æ¡ˆç»Ÿä¸€ (é¢„è®¡ 1-2 å°æ—¶)
â”œâ”€ ä¿®æ”¹ src/modules/menu/handler.py
â”‚   â”œâ”€ _build_reply_keyboard() æ–¹æ³•
â”‚   â””â”€ _build_promotion_buttons() æ–¹æ³•
â”œâ”€ ä¿®æ”¹ src/modules/menu/keyboards.py
â”‚   â””â”€ main_menu_inline() æ–¹æ³•
â””â”€ ä¿®æ”¹ src/modules/premium/messages.py
    â””â”€ START æ¶ˆæ¯æ¨¡æ¿

Phase 2: æŒ‰é’®æ˜ å°„è¡¥å…¨ (é¢„è®¡ 1 å°æ—¶)
â”œâ”€ src/modules/profile/keyboards.py
â”‚   â””â”€ back_to_profile() å¢åŠ è¿”å›ä¸»èœå•
â”œâ”€ src/modules/trx_exchange/handler.py
â”‚   â””â”€ start_exchange() å’Œ input_amount() å¢åŠ å–æ¶ˆæŒ‰é’®
â””â”€ æ£€æŸ¥æ‰€æœ‰æ¨¡å—é”®ç›˜æ˜¯å¦æœ‰è¿”å›è·¯å¾„

Phase 3: çŠ¶æ€æœºå¥å£®æ€§ (é¢„è®¡ 2 å°æ—¶)
â”œâ”€ src/modules/energy/handler.py
â”‚   â””â”€ ç¡®è®¤ STATE_INPUT_COUNT æ˜¯å¦éœ€è¦
â”œâ”€ src/modules/trx_exchange/handler.py
â”‚   â””â”€ å¢åŠ è¾“å…¥é˜¶æ®µçš„å–æ¶ˆ/è¶…æ—¶å¤„ç†
â””â”€ ç»Ÿä¸€æµ‹è¯•å„æµç¨‹çš„å–æ¶ˆ/è¿”å›

Phase 4: é”™è¯¯å¤„ç†ä¼˜åŒ– (é¢„è®¡ 1 å°æ—¶)
â”œâ”€ src/tasks/order_expiry.py
â”‚   â””â”€ _expire_single_order() å¢åŠ ç”¨æˆ·é€šçŸ¥
â””â”€ å…³é”®ä¸šåŠ¡æµç¨‹é”™è¯¯æ”¹ç”¨ error_collector

Phase 5: è‡ªåŠ¨åŒ–æµ‹è¯• (æŒç»­)
â”œâ”€ tests/test_navigation_smoke.py
â”‚   â””â”€ ä¸»èœå•å¯¼èˆªå†’çƒŸæµ‹è¯•
â”œâ”€ tests/test_premium_flow.py
â”‚   â””â”€ Premium è´­ä¹°æµç¨‹æµ‹è¯•
â””â”€ tests/test_address_query.py
    â””â”€ åœ°å€æŸ¥è¯¢æµç¨‹æµ‹è¯•
```

---

## å…«ã€é™„å½•

### 8.1 ç›¸å…³æ–‡ä»¶å¿«é€Ÿç´¢å¼•

| ç±»åˆ« | æ–‡ä»¶è·¯å¾„ |
|------|---------|
| ä¸»å…¥å£ | `src/bot_v2.py` |
| æ¨¡å—æ³¨å†Œ | `src/core/registry.py` |
| å¯¼èˆªç®¡ç† | `src/common/navigation_manager.py` |
| å¯¹è¯åŒ…è£… | `src/common/conversation_wrapper.py` |
| é”™è¯¯æ”¶é›† | `src/common/error_collector.py` |
| è®¢å•è¶…æ—¶ | `src/tasks/order_expiry.py` |
| Menu | `src/modules/menu/handler.py`, `keyboards.py`, `messages.py` |
| Premium | `src/modules/premium/handler.py`, `keyboards.py`, `messages.py`, `states.py` |
| Energy | `src/modules/energy/handler.py`, `keyboards.py`, `messages.py`, `states.py` |
| Profile | `src/modules/profile/handler.py`, `keyboards.py`, `messages.py`, `states.py` |
| TRX Exchange | `src/modules/trx_exchange/handler.py`, `keyboards.py`, `messages.py`, `states.py` |
| Address Query | `src/modules/address_query/handler.py`, `keyboards.py`, `messages.py`, `states.py` |
| Orders | `src/modules/orders/handler.py`, `query_handler.py` |
| Help | `src/modules/help/handler.py`, `keyboards.py`, `messages.py` |
| Admin | `src/modules/admin/handler.py` |

---

*æŠ¥å‘Šç”Ÿæˆå®Œæˆ*
