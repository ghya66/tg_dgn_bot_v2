# 📋 手动测试指南 - 能量和地址查询模块

## 🎯 测试目标

验证以下修复：
1. ✅ 能量模块 - 输入地址后正确显示支付信息
2. ✅ 地址查询模块 - 使用TronGrid API返回真实数据

## 🔧 已修复的问题

### 问题1: 能量模块 - 输入地址后无返回
**修复内容**:
- 在 `_show_payment_info` 方法中添加了详细的错误处理
- 添加了完整的日志记录
- 确保即使订单创建失败也能继续显示支付信息

**修改文件**: `src/modules/energy/handler.py`

### 问题2: 地址查询模块 - API不可用
**修复内容**:
- 集成TronGrid API获取真实地址数据
- 使用.env中配置的 `TRON_API_URL` 和 `TRON_API_KEY`
- 返回真实的TRX余额、USDT余额和交易历史

**修改文件**: `src/modules/address_query/handler.py`

## 📝 测试步骤

### 测试1: 能量模块 - 时长能量（闪租）

#### 步骤：
1. 在Telegram中找到 **@Gvhffjgd_bot**
2. 发送 `/start` 或 `/energy`
3. 点击 **⚡ 时长能量（闪租）**
4. 选择套餐：
   - **6.5万能量 = 3 TRX** 或
   - **13.1万能量 = 6 TRX**
5. 输入一个有效的TRON地址（例如：`TLyqzVGLV1srkB7dToTAEqgDSfPtXRJZYH`）

#### 预期结果：
✅ 应该显示支付信息，包括：
- 能量数量
- 价格（TRX）
- 接收地址
- 支付地址
- 订单ID
- 超时时间
- **✅ 已完成转账** 按钮

#### 日志检查：
```
用户 {user_id} 输入地址: {address}
地址验证通过，准备显示支付信息
能量订单创建成功: {order_id}
发送支付信息给用户: {user_id}
返回状态: STATE_SHOW_PAYMENT (5)
```

---

### 测试2: 能量模块 - 笔数套餐

#### 步骤：
1. 发送 `/energy`
2. 点击 **📦 笔数套餐**
3. 输入USDT金额（最低5 USDT）
4. 输入有效的TRON地址

#### 预期结果：
✅ 应该显示USDT支付信息

---

### 测试3: 能量模块 - 闪兑

#### 步骤：
1. 发送 `/energy`
2. 点击 **🔄 闪兑**
3. 输入USDT金额（最低1 USDT）
4. 输入有效的TRON地址

#### 预期结果：
✅ 应该显示USDT支付信息

---

### 测试4: 地址查询 - 真实API数据

#### 步骤：
1. 发送 `/query` 或点击 **🔍 地址查询**
2. 输入一个有效的TRON地址（建议使用有余额的地址）
   - 例如：`TLyqzVGLV1srkB7dToTAEqgDSfPtXRJZYH`

#### 预期结果：
✅ 应该显示真实的地址信息：
- **TRX余额**: 实际余额（不是0）
- **USDT余额**: 实际余额
- **最近5笔交易**: 如果有交易历史
- **🔗 链上查询详情** 按钮
- **🔍 查询转账记录** 按钮

#### 日志检查：
```
尝试获取地址信息: {address}
请求TronGrid API: https://api.trongrid.io/v1/accounts/{address}
成功获取地址信息: TRX={balance}, USDT={balance}
```

---

### 测试5: 错误处理

#### 测试5.1: 无效地址
**步骤**: 输入无效地址（如：`invalid_address`）

**预期结果**: 
✅ 显示错误提示："❌ 地址格式错误"

#### 测试5.2: 金额验证
**步骤**: 
- 笔数套餐输入 < 5 USDT
- 闪兑输入 < 1 USDT

**预期结果**: 
✅ 显示金额错误提示

---

## 🔍 日志监控

在测试过程中，监控bot日志以确保：

### 能量模块日志关键点：
```
用户 {user_id} 输入地址: {address}
地址验证通过，准备显示支付信息
能量订单创建成功: {order_id}
发送支付信息给用户: {user_id}
返回状态: STATE_SHOW_PAYMENT (5)
```

### 地址查询模块日志关键点：
```
尝试获取地址信息: {address}
请求TronGrid API: https://api.trongrid.io/v1/accounts/{address}
成功获取地址信息: TRX={balance}, USDT={balance}
```

## ✅ 测试检查清单

### 能量模块
- [ ] 时长能量 - 6.5万套餐
- [ ] 时长能量 - 13.1万套餐
- [ ] 笔数套餐 - 输入金额和地址
- [ ] 闪兑 - 输入金额和地址
- [ ] 无效地址错误提示
- [ ] 金额验证错误提示
- [ ] 返回按钮功能
- [ ] 取消按钮功能

### 地址查询模块
- [ ] 查询有余额的地址
- [ ] 查询空地址
- [ ] 无效地址错误提示
- [ ] 限频控制（10分钟内重复查询）
- [ ] 链上查询按钮跳转
- [ ] 交易记录按钮跳转

## 🐛 如果发现问题

### 能量模块问题
1. 检查日志中是否有 "能量订单创建成功" 消息
2. 检查是否有 "发送支付信息给用户" 消息
3. 检查返回状态是否为 STATE_SHOW_PAYMENT (5)
4. 如果订单创建失败，应该看到 "创建订单失败，但继续流程" 的警告

### 地址查询模块问题
1. 检查日志中是否有 "请求TronGrid API" 消息
2. 检查API返回状态码
3. 确认.env中 TRON_API_URL 和 TRON_API_KEY 配置正确
4. 如果API失败，应该显示 "API暂时不可用" 消息

## 📊 测试结果报告模板

```
测试时间: 2025-11-26 04:17
测试人员: [您的名字]

### 能量模块测试结果
- 时长能量（6.5万）: [ ] 通过 [ ] 失败
- 时长能量（13.1万）: [ ] 通过 [ ] 失败
- 笔数套餐: [ ] 通过 [ ] 失败
- 闪兑: [ ] 通过 [ ] 失败
- 错误处理: [ ] 通过 [ ] 失败

### 地址查询模块测试结果
- 真实数据查询: [ ] 通过 [ ] 失败
- 错误处理: [ ] 通过 [ ] 失败
- 限频控制: [ ] 通过 [ ] 失败

### 发现的问题
1. [描述问题]
2. [描述问题]

### 日志截图
[粘贴相关日志]
```

---

**测试完成后，请在此处报告结果！** 🎯
